# Спецификация функциональных требований SQLRC

## 2.2 Описание функциональности программной системы

SQLRC (SQL Record Creator) представляет собой инструмент командной строки, который автоматизирует процесс создания кода на языке Go для работы с базами данных. Система анализирует SQL-файлы со схемой базы данных и запросами, а затем генерирует соответствующие структуры данных и функции для взаимодействия с базой данных через стандартную библиотеку Go `database/sql`.

### Варианты использования

#### Вариант использования 1: Генерация кода на основе схемы базы данных

1. Пользователь создает SQL-файл с определениями таблиц (CREATE TABLE).
2. Пользователь создает конфигурационный файл, указывая путь к файлу схемы и другие параметры.
3. Пользователь запускает SQLRC с параметром `--cfg`, указывающим на конфигурационный файл.
4. Система анализирует файл схемы, извлекая информацию о таблицах и их структуре.
5. Система генерирует Go-код с определениями структур данных, соответствующих таблицам.
6. Система сохраняет сгенерированный код в файл `schema.go` в указанной директории.
7. Пользователь получает готовый к использованию Go-код для работы с данными из базы.

#### Вариант использования 2: Генерация кода для выполнения запросов

1. Пользователь создает SQL-файл с запросами, содержащими специальные комментарии и параметры.
2. Пользователь указывает путь к файлу запросов в конфигурационном файле.
3. Пользователь запускает SQLRC с параметром `--cfg`.
4. Система анализирует файл запросов, извлекая информацию о запросах, их параметрах и типах возвращаемых значений.
5. Система генерирует Go-код с функциями для выполнения запросов, структурами для параметров и результатов.
6. Система сохраняет сгенерированный код в файл `query.go` в указанной директории.
7. Пользователь получает готовый к использованию Go-код для выполнения запросов к базе данных.

#### Вариант использования 3: Интеграция сгенерированного кода в проект

1. Пользователь импортирует сгенерированный пакет в свой Go-проект.
2. Пользователь создает экземпляр структуры `Queries`, передавая ей соединение с базой данных.
3. Пользователь вызывает сгенерированные функции для выполнения запросов к базе данных.
4. Система обеспечивает типобезопасное взаимодействие с базой данных через сгенерированный код.

## 2.3 Спецификация функциональных требований

### 1. Парсинг конфигурационного файла

1. Система должна читать конфигурационный файл в формате "key:value\n".
2. Система должна поддерживать следующие параметры конфигурации:
   - `schema` - путь к файлу схемы SQL (обязательный параметр)
   - `queries` - путь к файлу запросов SQL (обязательный параметр)
   - `remove_trailing_s` - флаг для удаления окончания "s" из имен таблиц (необязательный параметр, по умолчанию false)
   - `pakage.name` - имя пакета Go (обязательный параметр)
   - `pakage.path` - путь к директории, в которую будут сгенерированы файлы (обязательный параметр)
3. Система должна корректно обрабатывать относительные и абсолютные пути в конфигурационном файле.
4. Система должна выдавать понятные сообщения об ошибках при отсутствии обязательных параметров или некорректном формате файла.

### 2. Чтение и анализ файла схемы базы данных

1. Система должна читать SQL-файл с определениями таблиц (CREATE TABLE).
2. Система должна корректно обрабатывать комментарии в SQL-коде, игнорируя их при анализе.
3. Система должна извлекать имена таблиц из операторов CREATE TABLE.
4. Система должна извлекать имена, типы и атрибуты полей таблиц.
5. Система должна поддерживать следующие типы данных SQL:
   - TEXT - соответствует типу string в Go
   - INTEGER - соответствует типу int в Go
6. Система должна определять, является ли поле обязательным (NOT NULL) или опциональным.
7. Система должна корректно обрабатывать первичные ключи (PRIMARY KEY).
8. Система должна выдавать понятные сообщения об ошибках при обнаружении неподдерживаемых типов данных или некорректного синтаксиса SQL.

### 3. Чтение и анализ файла запросов

1. Система должна читать SQL-файл с запросами.
2. Система должна распознавать специальные комментарии формата `--@ sqlrc:ИмяФункции:ТипВозврата`.
3. Система должна поддерживать следующие типы возвращаемых значений:
   - `one` - запрос, возвращающий одну запись
   - `many` - запрос, возвращающий несколько записей
   - `exec` - запрос, не возвращающий данные (INSERT, UPDATE, DELETE)
4. Система должна распознавать параметры запросов в формате `<@имя_параметра:тип_параметра@>`.
5. Система должна поддерживать следующие типы параметров:
   - `string` - строковый тип
   - `int` - целочисленный тип
6. Система должна корректно обрабатывать повторяющиеся параметры в запросе, заменяя их на плейсхолдеры `?` в сгенерированном SQL-коде.
7. Система должна анализировать результаты запросов для определения структуры возвращаемых данных.
8. Система должна выдавать понятные сообщения об ошибках при обнаружении неподдерживаемых типов параметров или некорректного синтаксиса SQL.

### 4. Генерация кода схемы

1. Система должна генерировать Go-код с определениями структур данных, соответствующих таблицам базы данных.
2. Сгенерированный код должен содержать структуру `Queries` с полем `DB` типа `*sql.DB`.
3. Для каждой таблицы должна быть сгенерирована отдельная структура с полями, соответствующими полям таблицы.
4. Имена структур должны быть в формате PascalCase, с первой буквой в верхнем регистре.
5. Если параметр `remove_trailing_s` установлен в true, система должна удалять окончание "s" из имен таблиц при генерации имен структур.
6. Поля структур должны иметь теги `db` с именами соответствующих полей таблицы.
7. Типы полей структур должны соответствовать типам полей таблицы:
   - TEXT -> string
   - INTEGER -> int
8. Сгенерированный код должен быть корректным Go-кодом, который компилируется без ошибок.
9. Сгенерированный код должен содержать импорт пакета `database/sql`.

### 5. Генерация кода запросов

1. Система должна генерировать Go-код с функциями для выполнения запросов к базе данных.
2. Для каждого запроса должна быть сгенерирована константа с SQL-запросом, в котором параметры заменены на плейсхолдеры `?`.
3. Для каждого запроса с параметрами должна быть сгенерирована структура с полями, соответствующими параметрам запроса.
4. Для запросов типа `one` и `many` должна быть сгенерирована структура с полями, соответствующими результатам запроса.
5. Для каждого запроса должна быть сгенерирована функция, принимающая контекст и структуру параметров и возвращающая результаты запроса.
6. Функции для запросов типа `one` должны возвращать указатель на структуру результата и ошибку.
7. Функции для запросов типа `many` должны возвращать срез структур результата и ошибку.
8. Функции для запросов типа `exec` должны возвращать результат выполнения запроса и ошибку.
9. Сгенерированный код должен корректно обрабатывать NULL-значения в результатах запросов.
10. Сгенерированный код должен быть корректным Go-кодом, который компилируется без ошибок.
11. Сгенерированный код должен содержать импорт пакета `context`.

### 6. Запись сгенерированных файлов

1. Система должна создавать директорию для сгенерированных файлов, если она не существует.
2. Система должна записывать сгенерированный код схемы в файл `schema.go` в указанной директории.
3. Система должна записывать сгенерированный код запросов в файл `query.go` в указанной директории.
4. Система должна корректно обрабатывать относительные и абсолютные пути при записи файлов.
5. Система должна выдавать понятные сообщения об ошибках при невозможности создания директории или записи файлов.

### 7. Интерфейс командной строки

1. Система должна предоставлять интерфейс командной строки с параметром `--cfg <путь_к_конфигурационному_файлу>`.
2. Система должна выводить информацию о ходе выполнения, включая сообщения о чтении файлов, генерации кода и записи файлов.
3. Система должна выводить сообщения об ошибках в понятном формате, указывая причину ошибки и возможные способы ее устранения.
4. Система должна возвращать ненулевой код возврата в случае ошибки.

### 8. Обработка ошибок

1. Система должна корректно обрабатывать ошибки чтения файлов, выдавая понятные сообщения.
2. Система должна корректно обрабатывать ошибки парсинга SQL-кода, указывая на проблемные места.
3. Система должна корректно обрабатывать ошибки генерации кода, указывая на причины ошибок.
4. Система должна корректно обрабатывать ошибки записи файлов, указывая на возможные причины (отсутствие прав доступа, недостаток места и т.д.).
5. Система должна предоставлять достаточно информации для диагностики и устранения ошибок.
